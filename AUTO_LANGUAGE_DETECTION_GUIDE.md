# Автоматическое определение языка пользователя

## Обзор
Реализована система автоматического определения языка пользователя на основе настроек браузера. Пользователи теперь будут видеть сайт на своем предпочитаемом языке при первом посещении.

## Что было реализовано

### 1. Включено автоматическое определение языка
- В `next-i18next.config.js` установлено `localeDetection: true`
- Next.js теперь автоматически определяет язык из заголовка `Accept-Language`

### 2. Создана утилита определения языка
**Файл:** `shared/utils/language-detection.js`

**Функции:**
- `detectUserLanguage()` - определяет язык из настроек браузера
- `getLanguageName(code)` - получает название языка по коду
- `isRTLLanguage(code)` - проверяет, является ли язык RTL
- `getUserLanguagePreference()` - получает сохраненные предпочтения пользователя
- `saveUserLanguagePreference(code)` - сохраняет предпочтения пользователя

### 3. Обновлен переключатель языков
**Файл:** `shared/language-switcher/LanguageSwitcher.jsx`

**Новые возможности:**
- Автоматическое определение языка при первом посещении
- Сохранение выбора пользователя в localStorage
- Улучшенный UX с запоминанием предпочтений

### 4. Создан middleware для серверного определения
**Файл:** `middleware.js`

**Функции:**
- Анализирует заголовок `Accept-Language`
- Автоматически перенаправляет на подходящий язык
- Поддерживает качество языков (q-values)

### 5. Добавлен баннер определения языка
**Файлы:** 
- `shared/language-detection-banner/LanguageDetectionBanner.jsx`
- `shared/language-detection-banner/language-detection-banner.scss`

**Возможности:**
- Показывается только при первом посещении
- Предлагает переключиться на определенный язык
- Современный дизайн с анимацией
- Поддержка RTL языков

### 6. Добавлены переводы
**Файлы:** `public/locales/*/common.json`

**Новые ключи:**
```json
{
  "common": {
    "yes": "Да/Yes",
    "no": "Нет/No",
    "languageDetection": {
      "title": "Мы определили ваши языковые предпочтения",
      "message": "Мы заметили, что вы, возможно, предпочитаете просматривать этот сайт на {{language}} вместо {{currentLanguage}}. Хотите переключиться?"
    }
  }
}
```

## Как это работает

### 1. Первое посещение
1. Пользователь заходит на сайт
2. Middleware анализирует `Accept-Language` заголовок
3. Если язык поддерживается - перенаправляет на соответствующую версию
4. Если не поддерживается - показывает английскую версию
5. LanguageSwitcher проверяет, нужно ли показать баннер

### 2. Повторные посещения
1. Система проверяет сохраненные предпочтения в localStorage
2. Если есть сохраненный язык - использует его
3. Если нет - определяет из браузера

### 3. Ручной выбор языка
1. Пользователь выбирает язык в переключателе
2. Язык сохраняется в localStorage
3. Баннер больше не показывается

## Поддерживаемые языки

- **en** - English (по умолчанию)
- **ru** - Русский
- **he** - עברית (RTL)
- **de** - Deutsch
- **fr** - Français
- **es** - Español
- **ar** - العربية (RTL)

## Настройка

### Отключение автоматического определения
Если нужно отключить автоматическое определение:

```javascript
// next-i18next.config.js
module.exports = {
  i18n: {
    localeDetection: false, // Отключить
    // ...
  }
};
```

### Настройка fallback языков
```javascript
// next-i18next.config.js
fallbackLng: {
  default: ['en'],
  he: ['en'], // Иврит fallback на английский
  ar: ['en'], // Арабский fallback на английский
}
```

## Тестирование

### 1. Тест автоматического определения
1. Очистите localStorage: `localStorage.clear()`
2. Измените язык браузера на поддерживаемый (например, русский)
3. Обновите страницу
4. Должен произойти редирект на русскую версию

### 2. Тест баннера
1. Очистите localStorage
2. Установите язык браузера, отличный от текущего языка сайта
3. Обновите страницу
4. Должен появиться баннер с предложением переключиться

### 3. Тест сохранения выбора
1. Выберите язык в переключателе
2. Обновите страницу
3. Язык должен сохраниться

## Производительность

- Минимальное влияние на производительность
- Определение языка происходит только при первом посещении
- Используется кэширование в localStorage
- Middleware работает на сервере, не блокирует клиент

## Совместимость

- ✅ Все современные браузеры
- ✅ Мобильные устройства
- ✅ RTL языки (иврит, арабский)
- ✅ SEO-дружественно
- ✅ Accessibility (WCAG 2.1)

## Устранение неполадок

### Проблема: Язык не определяется
**Решение:** Проверьте заголовок `Accept-Language` в DevTools → Network

### Проблема: Баннер не появляется
**Решение:** Очистите localStorage и проверьте консоль на ошибки

### Проблема: Неправильный редирект
**Решение:** Проверьте настройки middleware и поддерживаемые языки

## Дальнейшее развитие

1. **Геолокация** - определение языка по IP адресу
2. **A/B тестирование** - тестирование разных подходов к определению языка
3. **Аналитика** - отслеживание эффективности определения языка
4. **Персонализация** - запоминание других предпочтений пользователя
